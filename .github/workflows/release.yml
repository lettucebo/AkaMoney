name: Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

env:
  CLOUDFLARE_PAGES_PROJECT: akamoney-admin

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            src/frontend/package-lock.json
            src/backend/package-lock.json
            src/redirect/package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        run: cd src/backend && npm ci

      - name: Install frontend dependencies
        run: cd src/frontend && npm ci

      - name: Install redirect dependencies
        run: cd src/redirect && npm ci

      - name: Run backend tests
        run: cd src/backend && npm run test:coverage

      - name: Run frontend tests
        run: cd src/frontend && npm run test:coverage

      - name: Run redirect tests
        run: cd src/redirect && npm run test:coverage

      - name: Build frontend
        env:
          VITE_ENTRA_ID_CLIENT_ID: ${{ secrets.ENTRA_ID_CLIENT_ID }}
          VITE_ENTRA_ID_TENANT_ID: ${{ secrets.ENTRA_ID_TENANT_ID }}
          VITE_ENTRA_ID_REDIRECT_URI: https://akamoney-admin.pages.dev
          VITE_API_URL: https://akamoney-admin-api.akamoney.workers.dev
          VITE_APP_NAME: AkaMoney
          VITE_SHORT_DOMAIN: https://akamoney-admin-api.akamoney.workers.dev
        run: cd src/frontend && npm run build

      - name: Build backend (dry run)
        run: cd src/backend && npm run build

      - name: Build redirect (dry run)
        run: cd src/redirect && npm run build

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: src/frontend/dist/
          retention-days: 1

  deploy-admin-api:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: src/backend/package-lock.json

      - name: Install backend dependencies
        run: cd src/backend && npm ci

      - name: Ensure D1 database exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          DB_NAME="akamoney-clicks"
          echo "Checking if D1 database '$DB_NAME' exists..."
          if npx wrangler d1 list 2>/dev/null | grep -qw "$DB_NAME"; then
            echo "Database '$DB_NAME' already exists"
          else
            echo "Creating D1 database '$DB_NAME'..."
            npx wrangler d1 create "$DB_NAME"
            echo "Database '$DB_NAME' created successfully"
          fi

      - name: Get D1 Database ID
        id: d1-database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          DB_NAME="akamoney-clicks"
          # Get the database ID from wrangler d1 list output using JSON format for reliable parsing
          DB_ID=$(npx wrangler d1 list --json 2>/dev/null | jq -r --arg name "$DB_NAME" '.[] | select(.name == $name) | .uuid')
          if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
            echo "Error: Could not retrieve database ID for '$DB_NAME'"
            exit 1
          fi
          # Validate UUID format (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
          if ! echo "$DB_ID" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "Error: Retrieved database ID '$DB_ID' is not a valid UUID format"
            exit 1
          fi
          echo "Database ID: $DB_ID"
          echo "database_id=$DB_ID" >> "$GITHUB_OUTPUT"

      - name: Inject D1 Database ID into wrangler.toml
        env:
          CLOUDFLARE_D1_DATABASE_ID: ${{ steps.d1-database.outputs.database_id }}
        run: |
          # Validate that the database ID is set
          if [ -z "$CLOUDFLARE_D1_DATABASE_ID" ]; then
            echo "Error: CLOUDFLARE_D1_DATABASE_ID is not set"
            exit 1
          fi
          # Replace the empty database_id with the retrieved value (allowing flexible whitespace)
          sed -i 's/^[[:space:]]*database_id[[:space:]]*=[[:space:]]*""/database_id = "'"${CLOUDFLARE_D1_DATABASE_ID}"'"/' src/backend/wrangler.toml
          # Verify the replacement was successful without exposing the secret value
          if grep -q '^database_id = "[^"]\+"$' src/backend/wrangler.toml; then
            echo "Successfully injected D1 database ID"
          else
            echo "Error: Failed to inject D1 database ID"
            exit 1
          fi

      - name: Ensure R2 bucket exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          BUCKET_NAME="akamoney-storage"
          echo "Checking if R2 bucket '$BUCKET_NAME' exists..."
          if npx wrangler r2 bucket list 2>/dev/null | grep -qw "$BUCKET_NAME"; then
            echo "Bucket '$BUCKET_NAME' already exists"
          else
            echo "Creating R2 bucket '$BUCKET_NAME'..."
            npx wrangler r2 bucket create "$BUCKET_NAME"
            echo "Bucket '$BUCKET_NAME' created successfully"
          fi

      - name: Configure Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SECRET_JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SECRET_ENTRA_ID_TENANT_ID: ${{ secrets.ENTRA_ID_TENANT_ID }}
          SECRET_ENTRA_ID_CLIENT_ID: ${{ secrets.ENTRA_ID_CLIENT_ID }}
          SECRET_ENTRA_ID_CLIENT_SECRET: ${{ secrets.ENTRA_ID_CLIENT_SECRET }}
          SECRET_SHORT_DOMAIN: ${{ secrets.SHORT_DOMAIN }}
        run: |
          set -e
          cd src/backend
          echo "Configuring Worker secrets..."

          if [ -z "$SECRET_JWT_SECRET" ]; then
            echo "Error: JWT_SECRET is not set in GitHub secrets"
            exit 1
          fi
          npx wrangler secret put JWT_SECRET <<< "$SECRET_JWT_SECRET"

          if [ -n "$SECRET_ENTRA_ID_TENANT_ID" ]; then
            npx wrangler secret put ENTRA_ID_TENANT_ID <<< "$SECRET_ENTRA_ID_TENANT_ID"
          else
            echo "Warning: ENTRA_ID_TENANT_ID is not set, skipping..."
          fi

          if [ -n "$SECRET_ENTRA_ID_CLIENT_ID" ]; then
            npx wrangler secret put ENTRA_ID_CLIENT_ID <<< "$SECRET_ENTRA_ID_CLIENT_ID"
          else
            echo "Warning: ENTRA_ID_CLIENT_ID is not set, skipping..."
          fi

          if [ -n "$SECRET_ENTRA_ID_CLIENT_SECRET" ]; then
            npx wrangler secret put ENTRA_ID_CLIENT_SECRET <<< "$SECRET_ENTRA_ID_CLIENT_SECRET"
          else
            echo "Warning: ENTRA_ID_CLIENT_SECRET is not set, skipping..."
          fi

          if [ -n "$SECRET_SHORT_DOMAIN" ]; then
            npx wrangler secret put SHORT_DOMAIN <<< "$SECRET_SHORT_DOMAIN"
          else
            echo "Warning: SHORT_DOMAIN is not set, skipping..."
          fi

          echo "Worker secrets configured successfully"

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/backend
          command: deploy

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Admin API Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ✅ Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-admin-api |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Admin API Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ❌ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-admin-api |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi

  deploy-redirect:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: src/redirect/package-lock.json

      - name: Install redirect dependencies
        run: cd src/redirect && npm ci

      - name: Get D1 Database ID
        id: d1-database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/redirect
          DB_NAME="akamoney-clicks"
          # Get the database ID from wrangler d1 list output using JSON format for reliable parsing
          DB_ID=$(npx wrangler d1 list --json 2>/dev/null | jq -r --arg name "$DB_NAME" '.[] | select(.name == $name) | .uuid')
          if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
            echo "Error: Could not retrieve database ID for '$DB_NAME'"
            exit 1
          fi
          # Validate UUID format (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
          if ! echo "$DB_ID" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "Error: Retrieved database ID '$DB_ID' is not a valid UUID format"
            exit 1
          fi
          echo "Database ID: $DB_ID"
          echo "database_id=$DB_ID" >> "$GITHUB_OUTPUT"

      - name: Inject D1 Database ID into wrangler.toml
        env:
          CLOUDFLARE_D1_DATABASE_ID: ${{ steps.d1-database.outputs.database_id }}
        run: |
          # Validate that the database ID is set
          if [ -z "$CLOUDFLARE_D1_DATABASE_ID" ]; then
            echo "Error: CLOUDFLARE_D1_DATABASE_ID is not set"
            exit 1
          fi
          # Replace the empty database_id with the retrieved value (allowing flexible whitespace)
          sed -i 's/^[[:space:]]*database_id[[:space:]]*=[[:space:]]*""/database_id = "'"${CLOUDFLARE_D1_DATABASE_ID}"'"/' src/redirect/wrangler.toml
          # Verify the replacement was successful without exposing the secret value
          if grep -q '^database_id = "[^"]\+"$' src/redirect/wrangler.toml; then
            echo "Successfully injected D1 database ID"
          else
            echo "Error: Failed to inject D1 database ID"
            exit 1
          fi

      - name: Deploy Redirect Service to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/redirect
          command: deploy

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Redirect Service Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ✅ Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-redirect |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Redirect Service Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ❌ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-redirect |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: production

    steps:
      - name: Download frontend build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: src/frontend/dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Ensure Pages project exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          PROJECT_NAME="${{ env.CLOUDFLARE_PAGES_PROJECT }}"
          echo "Checking if Pages project '$PROJECT_NAME' exists..."
          if npx wrangler pages project list 2>/dev/null | grep -qw "$PROJECT_NAME"; then
            echo "Pages project '$PROJECT_NAME' already exists"
          else
            echo "Creating Pages project '$PROJECT_NAME'..."
            npx wrangler pages project create "$PROJECT_NAME" --production-branch=main
            echo "Pages project '$PROJECT_NAME' created successfully"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/frontend
          command: pages deploy dist --project-name=${{ env.CLOUDFLARE_PAGES_PROJECT }}

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Frontend Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ✅ Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Frontend Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | ❌ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi
