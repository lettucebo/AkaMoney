name: Release

# This workflow deploys the application to production.
# It skips redundant testing since code is already tested in CI workflow during PR.
# It only deploys services that have changed since the last release tag or commit.
# Supports automatic tag-based deployments and manual deployments via workflow_dispatch on any branch or tag.

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

env:
  CLOUDFLARE_PAGES_PROJECT: akamoney-admin

jobs:
  # Detect which services have changed to enable selective deployment
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      redirect: ${{ steps.filter.outputs.redirect }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: filter
        run: |
          # Determine comparison base based on trigger type
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For tag push, compare with previous tag
            echo "Trigger: Tag push"
            PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
            if [ -z "$PREV_TAG" ]; then
              echo "No previous tag found, deploying all services"
              COMPARE_BASE=""
            else
              echo "Comparing with previous tag: $PREV_TAG"
              COMPARE_BASE="$PREV_TAG"
            fi
          elif [[ "${{ github.ref }}" == refs/heads/* ]]; then
            # For branch push, compare with previous commit
            echo "Trigger: Branch push (${{ github.ref_name }})"
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              COMPARE_BASE="HEAD~1"
              echo "Comparing with previous commit: $COMPARE_BASE"
            else
              echo "No previous commit found (first commit?), deploying all services"
              COMPARE_BASE=""
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual trigger, try to find a reasonable comparison base
            echo "Trigger: Manual workflow dispatch"
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
              COMPARE_BASE="${PREV_TAG:-}"
            else
              # For branch manual trigger, compare with previous commit
              if git rev-parse HEAD~1 >/dev/null 2>&1; then
                COMPARE_BASE="HEAD~1"
              else
                COMPARE_BASE=""
              fi
            fi
            echo "Comparison base: ${COMPARE_BASE:-none (deploy all)}"
          else
            echo "Unknown trigger type, deploying all services"
            COMPARE_BASE=""
          fi

          # If no comparison base, deploy everything
          if [ -z "$COMPARE_BASE" ]; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            echo "redirect=true" >> "$GITHUB_OUTPUT"
            echo "any=true" >> "$GITHUB_OUTPUT"
          else
            # Get the diff once and store it
            CHANGED_FILES=$(git diff --name-only "$COMPARE_BASE" HEAD)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check for changes in each service
            # Pattern matches: src/{service}/* (including package.json) OR root package files
            if echo "$CHANGED_FILES" | grep -qE '^src/backend/|^package\.json|^package-lock\.json'; then
              echo "backend=true" >> "$GITHUB_OUTPUT"
              BACKEND_CHANGED=true
            else
              echo "backend=false" >> "$GITHUB_OUTPUT"
              BACKEND_CHANGED=false
            fi

            if echo "$CHANGED_FILES" | grep -qE '^src/frontend/|^package\.json|^package-lock\.json'; then
              echo "frontend=true" >> "$GITHUB_OUTPUT"
              FRONTEND_CHANGED=true
            else
              echo "frontend=false" >> "$GITHUB_OUTPUT"
              FRONTEND_CHANGED=false
            fi

            if echo "$CHANGED_FILES" | grep -qE '^src/redirect/|^package\.json|^package-lock\.json'; then
              echo "redirect=true" >> "$GITHUB_OUTPUT"
              REDIRECT_CHANGED=true
            else
              echo "redirect=false" >> "$GITHUB_OUTPUT"
              REDIRECT_CHANGED=false
            fi

            # Calculate 'any' flag
            if [ "$BACKEND_CHANGED" = "true" ] || [ "$FRONTEND_CHANGED" = "true" ] || [ "$REDIRECT_CHANGED" = "true" ]; then
              echo "any=true" >> "$GITHUB_OUTPUT"
            else
              echo "any=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Show deployment plan
        run: |
          echo "## Deployment Plan ðŸ“‹" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Will Deploy |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          
          # Backend status
          if [ "${{ steps.filter.outputs.backend }}" = "true" ]; then
            echo "| Backend API | âœ… Yes |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Backend API | â­ï¸ Skipped |" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Frontend status
          if [ "${{ steps.filter.outputs.frontend }}" = "true" ]; then
            echo "| Frontend | âœ… Yes |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Frontend | â­ï¸ Skipped |" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Redirect status
          if [ "${{ steps.filter.outputs.redirect }}" = "true" ]; then
            echo "| Redirect Service | âœ… Yes |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Redirect Service | â­ï¸ Skipped |" >> "$GITHUB_STEP_SUMMARY"
          fi

  # Build artifacts without running tests (tests already run in CI)
  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            src/frontend/package-lock.json
            src/backend/package-lock.json
            src/redirect/package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        if: needs.detect-changes.outputs.backend == 'true'
        run: cd src/backend && npm ci

      - name: Install frontend dependencies
        if: needs.detect-changes.outputs.frontend == 'true'
        run: cd src/frontend && npm ci

      - name: Install redirect dependencies
        if: needs.detect-changes.outputs.redirect == 'true'
        run: cd src/redirect && npm ci

      - name: Build frontend
        if: needs.detect-changes.outputs.frontend == 'true'
        env:
          VITE_ENTRA_ID_CLIENT_ID: ${{ vars.ENTRA_ID_CLIENT_ID }}
          VITE_ENTRA_ID_TENANT_ID: ${{ vars.ENTRA_ID_TENANT_ID }}
          VITE_ENTRA_ID_REDIRECT_URI: ${{ vars.ENTRA_ID_REDIRECT_URI }}
          VITE_API_URL: https://akamoney-admin-api.akamoney.workers.dev
          VITE_APP_NAME: AkaMoney
          VITE_SHORT_DOMAIN: ${{ vars.SHORT_DOMAIN }}
        run: cd src/frontend && npm run build

      - name: Build backend (dry run)
        if: needs.detect-changes.outputs.backend == 'true'
        run: cd src/backend && npm run build

      - name: Build redirect (dry run)
        if: needs.detect-changes.outputs.redirect == 'true'
        run: cd src/redirect && npm run build

      - name: Upload frontend build artifacts
        if: needs.detect-changes.outputs.frontend == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: src/frontend/dist/
          retention-days: 1

  deploy-admin-api:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.backend == 'true'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: src/backend/package-lock.json

      - name: Install backend dependencies
        run: cd src/backend && npm ci

      - name: Ensure D1 database exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          DB_NAME="akamoney-clicks"
          echo "Checking if D1 database '$DB_NAME' exists..."
          if npx wrangler d1 list 2>/dev/null | grep -qw "$DB_NAME"; then
            echo "Database '$DB_NAME' already exists"
          else
            echo "Creating D1 database '$DB_NAME'..."
            npx wrangler d1 create "$DB_NAME"
            echo "Database '$DB_NAME' created successfully"
          fi

      - name: Get D1 Database ID
        id: d1-database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          DB_NAME="akamoney-clicks"
          # Get the database ID from wrangler d1 list output using JSON format for reliable parsing
          DB_ID=$(npx wrangler d1 list --json 2>/dev/null | jq -r --arg name "$DB_NAME" '.[] | select(.name == $name) | .uuid')
          if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
            echo "Error: Could not retrieve database ID for '$DB_NAME'"
            exit 1
          fi
          # Validate UUID format (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
          if ! echo "$DB_ID" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "Error: Retrieved database ID '$DB_ID' is not a valid UUID format"
            exit 1
          fi
          echo "Database ID: $DB_ID"
          echo "database_id=$DB_ID" >> "$GITHUB_OUTPUT"

      - name: Inject D1 Database ID into wrangler.toml
        env:
          CLOUDFLARE_D1_DATABASE_ID: ${{ steps.d1-database.outputs.database_id }}
        run: |
          # Validate that the database ID is set
          if [ -z "$CLOUDFLARE_D1_DATABASE_ID" ]; then
            echo "Error: CLOUDFLARE_D1_DATABASE_ID is not set"
            exit 1
          fi
          # Replace the empty database_id with the retrieved value (allowing flexible whitespace)
          sed -i 's/^[[:space:]]*database_id[[:space:]]*=[[:space:]]*""/database_id = "'"${CLOUDFLARE_D1_DATABASE_ID}"'"/' src/backend/wrangler.toml
          # Verify the replacement was successful without exposing the secret value
          if grep -q '^database_id = "[^"]\+"$' src/backend/wrangler.toml; then
            echo "Successfully injected D1 database ID"
          else
            echo "Error: Failed to inject D1 database ID"
            exit 1
          fi

      - name: Ensure R2 bucket exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/backend
          BUCKET_NAME="akamoney-storage"
          echo "Checking if R2 bucket '$BUCKET_NAME' exists..."
          if npx wrangler r2 bucket list 2>/dev/null | grep -qw "$BUCKET_NAME"; then
            echo "Bucket '$BUCKET_NAME' already exists"
          else
            echo "Creating R2 bucket '$BUCKET_NAME'..."
            npx wrangler r2 bucket create "$BUCKET_NAME"
            echo "Bucket '$BUCKET_NAME' created successfully"
          fi

      - name: Configure Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          SECRET_ENTRA_ID_TENANT_ID: ${{ vars.ENTRA_ID_TENANT_ID }}
          SECRET_ENTRA_ID_CLIENT_ID: ${{ vars.ENTRA_ID_CLIENT_ID }}
          SECRET_ENTRA_ID_CLIENT_SECRET: ${{ secrets.ENTRA_ID_CLIENT_SECRET }}
          SECRET_SHORT_DOMAIN: ${{ vars.SHORT_DOMAIN }}
        run: |
          set -e
          cd src/backend
          echo "Configuring Worker secrets..."

          if [ -n "$SECRET_ENTRA_ID_TENANT_ID" ]; then
            npx wrangler secret put ENTRA_ID_TENANT_ID <<< "$SECRET_ENTRA_ID_TENANT_ID"
          else
            echo "Warning: ENTRA_ID_TENANT_ID is not set, skipping..."
          fi

          if [ -n "$SECRET_ENTRA_ID_CLIENT_ID" ]; then
            npx wrangler secret put ENTRA_ID_CLIENT_ID <<< "$SECRET_ENTRA_ID_CLIENT_ID"
          else
            echo "Warning: ENTRA_ID_CLIENT_ID is not set, skipping..."
          fi

          if [ -n "$SECRET_ENTRA_ID_CLIENT_SECRET" ]; then
            npx wrangler secret put ENTRA_ID_CLIENT_SECRET <<< "$SECRET_ENTRA_ID_CLIENT_SECRET"
          else
            echo "Warning: ENTRA_ID_CLIENT_SECRET is not set, skipping..."
          fi

          if [ -n "$SECRET_SHORT_DOMAIN" ]; then
            npx wrangler secret put SHORT_DOMAIN <<< "$SECRET_SHORT_DOMAIN"
          else
            echo "Warning: SHORT_DOMAIN is not set, skipping..."
          fi

          echo "Worker secrets configured successfully"

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/backend
          command: deploy

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Admin API Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âœ… Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-admin-api |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Admin API Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âŒ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-admin-api |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi

  deploy-redirect:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.redirect == 'true'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: src/redirect/package-lock.json

      - name: Install redirect dependencies
        run: cd src/redirect && npm ci

      - name: Get D1 Database ID
        id: d1-database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd src/redirect
          DB_NAME="akamoney-clicks"
          # Get the database ID from wrangler d1 list output using JSON format for reliable parsing
          DB_ID=$(npx wrangler d1 list --json 2>/dev/null | jq -r --arg name "$DB_NAME" '.[] | select(.name == $name) | .uuid')
          if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
            echo "Error: Could not retrieve database ID for '$DB_NAME'"
            exit 1
          fi
          # Validate UUID format (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
          if ! echo "$DB_ID" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "Error: Retrieved database ID '$DB_ID' is not a valid UUID format"
            exit 1
          fi
          echo "Database ID: $DB_ID"
          echo "database_id=$DB_ID" >> "$GITHUB_OUTPUT"

      - name: Inject D1 Database ID into wrangler.toml
        env:
          CLOUDFLARE_D1_DATABASE_ID: ${{ steps.d1-database.outputs.database_id }}
        run: |
          # Validate that the database ID is set
          if [ -z "$CLOUDFLARE_D1_DATABASE_ID" ]; then
            echo "Error: CLOUDFLARE_D1_DATABASE_ID is not set"
            exit 1
          fi
          # Replace the empty database_id with the retrieved value (allowing flexible whitespace)
          sed -i 's/^[[:space:]]*database_id[[:space:]]*=[[:space:]]*""/database_id = "'"${CLOUDFLARE_D1_DATABASE_ID}"'"/' src/redirect/wrangler.toml
          # Verify the replacement was successful without exposing the secret value
          if grep -q '^database_id = "[^"]\+"$' src/redirect/wrangler.toml; then
            echo "Successfully injected D1 database ID"
          else
            echo "Error: Failed to inject D1 database ID"
            exit 1
          fi

      - name: Deploy Redirect Service to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/redirect
          command: deploy

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Redirect Service Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âœ… Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-redirect |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Redirect Service Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âŒ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Service** | akamoney-redirect |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.frontend == 'true'
    environment: production

    steps:
      - name: Download frontend build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: src/frontend/dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Ensure Pages project exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          PROJECT_NAME="${{ env.CLOUDFLARE_PAGES_PROJECT }}"
          echo "Checking if Pages project '$PROJECT_NAME' exists..."
          if npx wrangler pages project list 2>/dev/null | grep -qw "$PROJECT_NAME"; then
            echo "Pages project '$PROJECT_NAME' already exists"
          else
            echo "Creating Pages project '$PROJECT_NAME'..."
            npx wrangler pages project create "$PROJECT_NAME" --production-branch=main
            echo "Pages project '$PROJECT_NAME' created successfully"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: src/frontend
          command: pages deploy dist --project-name=${{ env.CLOUDFLARE_PAGES_PROJECT }}

      - name: Add deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "## Frontend Deployment Summary :rocket:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âœ… Deployed successfully |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Frontend Deployment Summary :x:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Status** | âŒ Deployment failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Environment** | Production |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Commit** | ${{ github.sha }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Ref** | ${{ github.ref_name }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Please check the workflow logs for more details." >> "$GITHUB_STEP_SUMMARY"
          fi
